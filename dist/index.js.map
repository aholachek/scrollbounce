{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import { SpringSystem } from \"rebound\"\n\nconst getViewportCoords = () => {\n  return {\n    height: document.documentElement.clientHeight,\n    width: document.documentElement.clientWidth\n  }\n}\n\nconst getScrollHeight = () => {\n  // insane code courtesy of https://javascript.info/size-and-scroll-window\n  return Math.max(\n    document.body.scrollHeight,\n    document.documentElement.scrollHeight,\n    document.body.offsetHeight,\n    document.documentElement.offsetHeight,\n    document.body.clientHeight,\n    document.documentElement.clientHeight\n  )\n}\n\nconst rectInViewport = (\n  { top, bottom, left, right },\n  { width: windowWidth, height: windowHeight }\n) => {\n  return top < windowHeight && bottom > 0 && left < windowWidth && right > 0\n}\n\nconst rectCloseToViewport = ({ top, bottom }, { height: windowHeight }) => {\n  return top < windowHeight * 3 && bottom > -windowHeight * 2\n}\n\nconst initScrollBounce = ({ effectMultiplier = 2 } = {}) => {\n  const springSystem = new SpringSystem()\n\n  const bounceChildren = Array.from(\n    document.querySelectorAll(\"[data-bounce-id]\")\n  )\n\n  let offset = window.pageYOffset\n\n  const springs = bounceChildren\n    .map(child => {\n      const spring = springSystem.createSpring()\n\n      spring.addListener({\n        onSpringUpdate(_spring) {\n          const val = _spring.getCurrentValue()\n          child.style.transform = `translateY(${val}px)`\n        }\n      })\n      return [child, spring]\n    })\n    .reduce((acc, curr) => {\n      acc[curr[0].dataset.bounceId] = curr[1]\n      return acc\n    }, {})\n\n  const resetSprings = () => {\n    Object.keys(springs).forEach(s => {\n      springs[s].setEndValue(0)\n    })\n  }\n\n  let cache = {}\n\n  const getCenter = bounding => {\n    return bounding.top + bounding.height / 2\n  }\n\n  const onScroll = () => {\n    if (!cache.scrollHeight) cache.scrollHeight = getScrollHeight()\n\n    const fastScroll = Math.abs(diff) > cache.viewportCoords.height\n    if (fastScroll) return\n\n    const newOffset = window.pageYOffset\n\n    if (newOffset <= 0) return\n\n    if (newOffset >= cache.scrollHeight - cache.viewportCoords.height) {\n      return\n    }\n    const diff = offset - newOffset\n\n    const closestChild = document.querySelector([\n      `[data-bounce-id=\"${cache.closestBounceId}\"]`\n    ])\n\n    const closestChildIndex = bounceChildren.indexOf(closestChild)\n\n    const animatedChildrenDict = {}\n\n    let animatedAboveIndex = closestChildIndex - 1\n    let animatedBelowIndex = closestChildIndex + 1\n\n    const scrollDown = diff > 0\n\n    if (scrollDown) {\n      while (true) {\n        const el = bounceChildren[animatedAboveIndex]\n        if (!el) break\n        const bounding = el.getBoundingClientRect()\n        const isAnimated = rectCloseToViewport(bounding, cache.viewportCoords)\n        if (!isAnimated) break\n        animatedChildrenDict[el.dataset.bounceId] = bounding\n        animatedAboveIndex -= 1\n      }\n    } else {\n      while (true) {\n        const el = bounceChildren[animatedBelowIndex]\n        if (!el) break\n        const bounding = el.getBoundingClientRect()\n        const isAnimated = rectCloseToViewport(bounding, cache.viewportCoords)\n        if (!isAnimated) break\n        animatedChildrenDict[el.dataset.bounceId] = bounding\n        animatedBelowIndex += 1\n      }\n    }\n\n    const animatedChildren = bounceChildren\n      .filter(c => {\n        return animatedChildrenDict[c.dataset.bounceId]\n      })\n      .map(c => {\n        return [c, animatedChildrenDict[c.dataset.bounceId]]\n      })\n\n    bounceChildren\n      .filter(c => {\n        return !animatedChildrenDict[c.dataset.bounceId]\n      })\n      .forEach(c => {\n        c.style.willChange = \"\"\n        springs[c.dataset.bounceId].setEndValue(0)\n      })\n\n    animatedChildren.forEach(([child, bounding]) => {\n      child.style.willChange = \"transform\"\n\n      const spring = springs[child.dataset.bounceId]\n\n      let resistance =\n        Math.abs(cache.clientY - getCenter(bounding)) /\n        cache.viewportCoords.height\n\n      resistance = resistance * effectMultiplier\n\n      spring.setEndValue(-diff * resistance)\n    })\n\n    offset = newOffset\n  }\n\n  let scrollListener = false\n\n  const onTouchStart = event => {\n    if (!scrollListener)\n      scrollListener = window.addEventListener(\"scroll\", onScroll)\n    cache.clientY = event.targetTouches[0].clientY\n\n    cache.viewportCoords = getViewportCoords()\n\n    const closestElTuple = bounceChildren.reduce((acc, curr, i, source) => {\n      if (acc.length && acc[0] !== source[i - 1]) return acc\n      const bounding = curr.getBoundingClientRect()\n      if (!rectInViewport(bounding, cache.viewportCoords)) return acc\n      if (\n        acc.length === 0 ||\n        Math.abs(cache.clientY - getCenter(bounding)) <\n          Math.abs(cache.clientY - getCenter(acc[1]))\n      ) {\n        return [curr, bounding]\n      }\n      return acc\n    }, [])\n\n    cache.closestBounceId = closestElTuple[0].dataset.bounceId\n  }\n\n  const onTouchEnd = () => {\n    window.removeEventListener(\"scroll\", onScroll)\n    resetSprings()\n    cache = {}\n  }\n\n  const onTouchMove = event => {\n    cache.clientY = event.targetTouches[0].clientY\n  }\n\n  window.addEventListener(\"touchstart\", onTouchStart, false)\n  window.addEventListener(\"touchmove\", onTouchMove, false)\n  window.addEventListener(\"touchend\", onTouchEnd, false)\n\n  return () => {\n    window.removeEventListener(\"touchstart\", onTouchStart, false)\n    window.removeEventListener(\"touchmove\", onTouchMove, false)\n    window.removeEventListener(\"touchend\", onTouchEnd, false)\n  }\n}\n\nexport default initScrollBounce\n"],"names":["rectCloseToViewport","ref","ref$1","windowHeight","springSystem","SpringSystem","bounceChildren","Array","from","document","querySelectorAll","offset","window","pageYOffset","springs","map","child","spring","createSpring","addListener","onSpringUpdate","_spring","val","getCurrentValue","style","transform","reduce","acc","curr","dataset","bounceId","cache","getCenter","bounding","top","height","onScroll","scrollHeight","Math","max","body","documentElement","offsetHeight","clientHeight","abs","diff","viewportCoords","newOffset","closestChild","querySelector","closestChildIndex","indexOf","animatedChildrenDict","animatedAboveIndex","animatedBelowIndex","el","getBoundingClientRect","animatedChildren","filter","c","forEach","willChange","setEndValue","resistance","clientY","effectMultiplier","scrollListener","onTouchStart","event","addEventListener","targetTouches","width","clientWidth","closestElTuple","i","source","length","closestBounceId","onTouchEnd","removeEventListener","Object","keys","s","onTouchMove"],"mappings":"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"}