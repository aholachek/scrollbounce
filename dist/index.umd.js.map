{"version":3,"file":"index.umd.js","sources":["../src/index.js"],"sourcesContent":["import { SpringSystem } from \"rebound\"\n\nconst getViewportCoords = () => {\n  return {\n    height: document.documentElement.clientHeight,\n    width: document.documentElement.clientWidth\n  }\n}\n\nconst getScrollHeight = () => {\n  // insane code courtesy of https://javascript.info/size-and-scroll-window\n  return Math.max(\n    document.body.scrollHeight,\n    document.documentElement.scrollHeight,\n    document.body.offsetHeight,\n    document.documentElement.offsetHeight,\n    document.body.clientHeight,\n    document.documentElement.clientHeight\n  )\n}\n\nconst rectInViewport = (\n  { top, bottom, left, right },\n  { width: windowWidth, height: windowHeight }\n) => {\n  return top < windowHeight && bottom > 0 && left < windowWidth && right > 0\n}\n\nconst rectCloseToViewport = ({ top, bottom }, { height: windowHeight }) => {\n  return top < windowHeight * 3 && bottom > -windowHeight * 2\n}\n\nconst initScrollBounce = ({ effectMultiplier = 2 } = {}) => {\n  const springSystem = new SpringSystem()\n\n  const bounceChildren = Array.from(\n    document.querySelectorAll(\"[data-bounce-id]\")\n  )\n\n  let offset = window.pageYOffset\n\n  const springs = bounceChildren\n    .map(child => {\n      const spring = springSystem.createSpring()\n\n      spring.addListener({\n        onSpringUpdate(_spring) {\n          const val = _spring.getCurrentValue()\n          child.style.transform = `translateY(${val}px)`\n        }\n      })\n      return [child, spring]\n    })\n    .reduce((acc, curr) => {\n      acc[curr[0].dataset.bounceId] = curr[1]\n      return acc\n    }, {})\n\n  const resetSprings = () => {\n    Object.keys(springs).forEach(s => {\n      springs[s].setEndValue(0)\n    })\n  }\n\n  let cache = {}\n\n  const getCenter = bounding => {\n    return bounding.top + bounding.height / 2\n  }\n\n  const onScroll = () => {\n    if (!cache.scrollHeight) cache.scrollHeight = getScrollHeight()\n\n    const fastScroll = Math.abs(diff) > cache.viewportCoords.height\n    if (fastScroll) return\n\n    const newOffset = window.pageYOffset\n\n    if (newOffset <= 0) return\n\n    if (newOffset >= cache.scrollHeight - cache.viewportCoords.height) {\n      return\n    }\n\n    const scrollDiffLimit = 40\n    const diff = Math.max(\n      -scrollDiffLimit,\n      Math.min(offset - newOffset, scrollDiffLimit)\n    )\n\n    const closestChild = document.querySelector([\n      `[data-bounce-id=\"${cache.closestBounceId}\"]`\n    ])\n\n    const closestChildIndex = bounceChildren.indexOf(closestChild)\n\n    const animatedChildrenDict = {}\n\n    let animatedAboveIndex = closestChildIndex - 1\n    let animatedBelowIndex = closestChildIndex + 1\n\n    const scrollDown = diff > 0\n\n    if (scrollDown) {\n      while (true) {\n        const el = bounceChildren[animatedAboveIndex]\n        if (!el) break\n        const bounding = el.getBoundingClientRect()\n        const isAnimated = rectCloseToViewport(bounding, cache.viewportCoords)\n        if (!isAnimated) break\n        animatedChildrenDict[el.dataset.bounceId] = bounding\n        animatedAboveIndex -= 1\n      }\n    } else {\n      while (true) {\n        const el = bounceChildren[animatedBelowIndex]\n        if (!el) break\n        const bounding = el.getBoundingClientRect()\n        const isAnimated = rectCloseToViewport(bounding, cache.viewportCoords)\n        if (!isAnimated) break\n        animatedChildrenDict[el.dataset.bounceId] = bounding\n        animatedBelowIndex += 1\n      }\n    }\n\n    const animatedChildren = bounceChildren\n      .filter(c => {\n        return animatedChildrenDict[c.dataset.bounceId]\n      })\n      .map(c => {\n        return [c, animatedChildrenDict[c.dataset.bounceId]]\n      })\n\n    bounceChildren\n      .filter(c => {\n        return !animatedChildrenDict[c.dataset.bounceId]\n      })\n      .forEach(c => {\n        c.style.willChange = \"\"\n        springs[c.dataset.bounceId].setEndValue(0)\n      })\n\n    animatedChildren.forEach(([child, bounding]) => {\n      child.style.willChange = \"transform\"\n\n      const spring = springs[child.dataset.bounceId]\n\n      let resistance =\n        Math.abs(cache.clientY - getCenter(bounding)) /\n        cache.viewportCoords.height\n\n      resistance = resistance * effectMultiplier\n\n      spring.setEndValue(-diff * resistance)\n    })\n\n    offset = newOffset\n  }\n\n  let scrollListener = false\n\n  const onTouchStart = event => {\n    if (!scrollListener)\n      scrollListener = window.addEventListener(\"scroll\", onScroll)\n    cache.clientY = event.targetTouches[0].clientY\n\n    cache.viewportCoords = getViewportCoords()\n\n    const closestElTuple = bounceChildren.reduce((acc, curr, i, source) => {\n      if (acc.length && acc[0] !== source[i - 1]) return acc\n      const bounding = curr.getBoundingClientRect()\n      if (!rectInViewport(bounding, cache.viewportCoords)) return acc\n      if (\n        acc.length === 0 ||\n        Math.abs(cache.clientY - getCenter(bounding)) <\n          Math.abs(cache.clientY - getCenter(acc[1]))\n      ) {\n        return [curr, bounding]\n      }\n      return acc\n    }, [])\n\n    cache.closestBounceId = closestElTuple[0].dataset.bounceId\n  }\n\n  const onTouchEnd = () => {\n    window.removeEventListener(\"scroll\", onScroll)\n    resetSprings()\n    cache = {}\n  }\n\n  const onTouchMove = event => {\n    cache.clientY = event.targetTouches[0].clientY\n  }\n\n  window.addEventListener(\"touchstart\", onTouchStart, false)\n  window.addEventListener(\"touchmove\", onTouchMove, false)\n  window.addEventListener(\"touchend\", onTouchEnd, false)\n\n  return () => {\n    window.removeEventListener(\"touchstart\", onTouchStart, false)\n    window.removeEventListener(\"touchmove\", onTouchMove, false)\n    window.removeEventListener(\"touchend\", onTouchEnd, false)\n  }\n}\n\nexport default initScrollBounce\n"],"names":["const","rectCloseToViewport","ref","ref$1","windowHeight","springSystem","SpringSystem","bounceChildren","Array","from","document","querySelectorAll","offset","window","pageYOffset","springs","map","child","spring","createSpring","addListener","onSpringUpdate","_spring","val","getCurrentValue","style","transform","reduce","acc","curr","dataset","bounceId","cache","getCenter","bounding","top","height","onScroll","scrollHeight","Math","max","body","documentElement","offsetHeight","clientHeight","abs","diff","viewportCoords","newOffset","min","closestChild","querySelector","closestChildIndex","indexOf","animatedChildrenDict","animatedAboveIndex","animatedBelowIndex","el","getBoundingClientRect","animatedChildren","filter","c","forEach","willChange","setEndValue","resistance","clientY","effectMultiplier","scrollListener","onTouchStart","event","addEventListener","targetTouches","width","clientWidth","closestElTuple","i","source","length","closestBounceId","onTouchEnd","removeEventListener","Object","keys","s","onTouchMove"],"mappings":"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"}